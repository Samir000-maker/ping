<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Multi-Server Keep-alive Monitor</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; 
    padding: 20px; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    margin: 0;
  }
  .container {
    max-width: 1400px;
    margin: 0 auto;
    background: #fff;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  h1 { 
    margin: 0 0 8px 0; 
    font-size: 28px; 
    color: #1a1a1a;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .subtitle {
    color: #666;
    font-size: 14px;
    margin-bottom: 20px;
  }
  
  /* Global Controls */
  .global-controls {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 24px;
    border: 2px solid #e9ecef;
  }
  .global-controls h2 {
    margin: 0 0 12px 0;
    font-size: 16px;
    color: #495057;
  }
  .btn-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  button {
    padding: 10px 18px;
    border-radius: 6px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
  }
  button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  button:active { transform: translateY(0); }
  .btn-start { background: #28a745; color: #fff; }
  .btn-start:hover { background: #218838; }
  .btn-pause { background: #ffc107; color: #000; }
  .btn-pause:hover { background: #e0a800; }
  .btn-stop { background: #dc3545; color: #fff; }
  .btn-stop:hover { background: #c82333; }
  .btn-clear { background: #6c757d; color: #fff; }
  .btn-clear:hover { background: #5a6268; }
  .btn-download { background: #17a2b8; color: #fff; }
  .btn-download:hover { background: #138496; }
  
  .global-status {
    margin-top: 12px;
    padding: 12px;
    background: #fff;
    border-radius: 6px;
    font-size: 14px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }
  .global-status .stat {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .global-status .stat-label {
    color: #666;
    font-weight: 500;
  }
  .global-status .stat-value {
    font-weight: 700;
    color: #1a1a1a;
  }
  .status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    animation: pulse 2s infinite;
  }
  .status-running { background: #28a745; }
  .status-paused { background: #ffc107; }
  .status-stopped { background: #dc3545; }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  /* Server Grid */
  .servers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
  }
  
  .server-card {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    background: #fff;
    transition: all 0.3s;
  }
  .server-card:hover {
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
  }
  
  .server-header {
    padding: 14px 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .server-name {
    font-weight: 700;
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .server-status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
  }
  .badge-running { background: #28a745; }
  .badge-paused { background: #ffc107; color: #000; }
  .badge-stopped { background: #dc3545; }
  
  .server-body {
    padding: 16px;
  }
  .server-url {
    font-size: 12px;
    color: #666;
    word-break: break-all;
    margin-bottom: 12px;
    font-family: monospace;
    background: #f8f9fa;
    padding: 6px 8px;
    border-radius: 4px;
  }
  
  .server-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 12px;
    font-size: 13px;
  }
  .server-stats .stat-item {
    background: #f8f9fa;
    padding: 8px;
    border-radius: 4px;
  }
  .server-stats .stat-label {
    color: #666;
    font-size: 11px;
    text-transform: uppercase;
    font-weight: 600;
  }
  .server-stats .stat-value {
    font-size: 18px;
    font-weight: 700;
    color: #1a1a1a;
  }
  .stat-success { color: #28a745 !important; }
  .stat-fail { color: #dc3545 !important; }
  
  .server-controls {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }
  .server-controls button {
    flex: 1;
    padding: 8px;
    font-size: 13px;
  }
  
  .server-last-ping {
    margin-top: 10px;
    padding: 8px;
    background: #e9ecef;
    border-radius: 4px;
    font-size: 12px;
    color: #495057;
  }
  .ping-ok { background: #d4edda !important; color: #155724 !important; }
  .ping-fail { background: #f8d7da !important; color: #721c24 !important; }
  
  /* Unified Log */
  .log-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
  }
  .log-section h2 {
    margin: 0 0 12px 0;
    font-size: 16px;
    color: #495057;
  }
  #logArea {
    white-space: pre-wrap;
    font-family: "Courier New", monospace;
    background: #0d1117;
    color: #c9d1d9;
    padding: 16px;
    border-radius: 6px;
    height: 400px;
    overflow: auto;
    border: 2px solid #30363d;
    font-size: 13px;
    line-height: 1.5;
  }
  #logArea::-webkit-scrollbar { width: 10px; }
  #logArea::-webkit-scrollbar-track { background: #0d1117; }
  #logArea::-webkit-scrollbar-thumb { background: #30363d; border-radius: 5px; }
  #logArea::-webkit-scrollbar-thumb:hover { background: #484f58; }
  
  .log-line { margin-bottom: 2px; }
  .log-server1 { color: #58a6ff; }
  .log-server2 { color: #79c0ff; }
  .log-server3 { color: #d2a8ff; }
  .log-server4 { color: #ffa657; }
  .log-ok { color: #7ee787; }
  .log-warn { color: #f0c86e; }
  .log-err { color: #ff7b72; }
  .log-info { color: #8b949e; }
</style>
</head>
<body>
  <div class="container">
    <h1>
      <span style="font-size: 32px;">üîÑ</span>
      Multi-Server Keep-Alive Monitor
    </h1>
    <div class="subtitle">Monitoring 4 servers with 2-minute intervals and intelligent backoff</div>
    
    <!-- Global Controls -->
    <div class="global-controls">
      <h2>üéõÔ∏è Global Controls</h2>
      <div class="btn-group">
        <button id="btnStartAll" class="btn-start">‚ñ∂Ô∏è Start All</button>
        <button id="btnPauseAll" class="btn-pause">‚è∏Ô∏è Pause All</button>
        <button id="btnStopAll" class="btn-stop">‚èπÔ∏è Stop All</button>
        <button id="btnClearLog" class="btn-clear">üóëÔ∏è Clear Log</button>
        <button id="btnDownloadLog" class="btn-download">üíæ Download Log</button>
      </div>
      <div class="global-status">
        <div class="stat">
          <span class="stat-label">Status:</span>
          <span class="status-indicator" id="globalStatusIndicator"></span>
          <span class="stat-value" id="globalStatusText">Stopped</span>
        </div>
        <div class="stat">
          <span class="stat-label">Interval:</span>
          <span class="stat-value">2 minutes</span>
        </div>
        <div class="stat">
          <span class="stat-label">Total Success:</span>
          <span class="stat-value stat-success" id="totalSuccess">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">Total Fails:</span>
          <span class="stat-value stat-fail" id="totalFail">0</span>
        </div>
      </div>
    </div>
    
    <!-- Server Cards Grid -->
    <div class="servers-grid" id="serversGrid"></div>
    
    <!-- Unified Log -->
    <div class="log-section">
      <h2>üìã Unified Activity Log</h2>
      <div id="logArea"></div>
    </div>
  </div>

<script>
(() => {
  // Configuration
  const SERVERS = [
    { id: 1, name: 'Samir Server', url: 'https://samir-hgr9.onrender.com/health', color: 'log-server1' },
    { id: 2, name: 'Server 1', url: 'https://server1-ki1x.onrender.com/health', color: 'log-server2' },
    { id: 3, name: 'Database', url: 'https://database-22io.onrender.com/health', color: 'log-server3' },
    { id: 4, name: 'Local Server', url: 'https://local-server-yi1q.onrender.com/health', color: 'log-server4' }
  ];
  
  const TARGET_INTERVAL_MS = 2 * 60 * 1000; // 2 minutes
  const JITTER_MS = 5000; // +/- 5 seconds
  const FETCH_TIMEOUT_MS = 90000; // 90 seconds timeout (for Render free tier wake-up)
  const MAX_LOG_LINES = 1000;
  const INITIAL_BACKOFF_MS = TARGET_INTERVAL_MS;
  const MAX_BACKOFF_MS = 10 * 60 * 1000; // 10 minutes max backoff
  
  // Global state
  let globalRunning = false;
  let logLines = [];
  let totalSuccess = 0;
  let totalFail = 0;
  
  // Server states
  const serverStates = {};
  SERVERS.forEach(server => {
    serverStates[server.id] = {
      running: false,
      attempts: 0,
      success: 0,
      fail: 0,
      backoff: 0,
      timerId: null,
      lastPing: null,
      lastStatus: 'stopped'
    };
  });
  
  // DOM elements
  const logEl = document.getElementById('logArea');
  const globalStatusText = document.getElementById('globalStatusText');
  const globalStatusIndicator = document.getElementById('globalStatusIndicator');
  const totalSuccessEl = document.getElementById('totalSuccess');
  const totalFailEl = document.getElementById('totalFail');
  const serversGrid = document.getElementById('serversGrid');
  
  // Utility functions
  function nowISO() { return new Date().toISOString(); }
  
  function addLog(msg, cssClass = 'log-info', serverColor = null) {
    const ts = nowISO();
    const time = ts.substring(11, 19);
    const line = `[${time}] ${msg}`;
    logLines.push({ t: ts, text: line, cls: cssClass, serverColor });
    if (logLines.length > MAX_LOG_LINES) {
      logLines.splice(0, logLines.length - MAX_LOG_LINES);
    }
    renderLog();
  }
  
  function renderLog() {
    logEl.innerHTML = logLines.map(l => {
      const classes = [l.cls, l.serverColor].filter(Boolean).join(' ');
      const safe = l.text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      return `<div class="log-line ${classes}">${safe}</div>`;
    }).join('');
    logEl.scrollTop = logEl.scrollHeight;
  }
  
  function updateGlobalStats() {
    totalSuccessEl.textContent = totalSuccess;
    totalFailEl.textContent = totalFail;
    
    const anyRunning = Object.values(serverStates).some(s => s.running);
    if (anyRunning) {
      globalStatusText.textContent = 'Running';
      globalStatusIndicator.className = 'status-indicator status-running';
    } else if (globalRunning) {
      globalStatusText.textContent = 'Paused';
      globalStatusIndicator.className = 'status-indicator status-paused';
    } else {
      globalStatusText.textContent = 'Stopped';
      globalStatusIndicator.className = 'status-indicator status-stopped';
    }
  }
  
  function updateServerCard(serverId) {
    const state = serverStates[serverId];
    const card = document.getElementById(`server-${serverId}`);
    if (!card) return;
    
    card.querySelector('.server-status-badge').textContent = state.lastStatus;
    card.querySelector('.server-status-badge').className = 
      `server-status-badge badge-${state.lastStatus}`;
    
    card.querySelector('.stat-attempts').textContent = state.attempts;
    card.querySelector('.stat-success').textContent = state.success;
    card.querySelector('.stat-fail').textContent = state.fail;
    card.querySelector('.stat-backoff').textContent = 
      state.backoff ? `${Math.round(state.backoff/1000)}s` : 'none';
    
    if (state.lastPing) {
      const lastPingEl = card.querySelector('.server-last-ping');
      lastPingEl.textContent = state.lastPing.message;
      lastPingEl.className = `server-last-ping ${state.lastPing.success ? 'ping-ok' : 'ping-fail'}`;
    }
  }
  
  // Fetch with timeout
  async function fetchWithTimeout(url, timeoutMs = FETCH_TIMEOUT_MS) {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeoutMs);
    try {
      const resp = await fetch(url, {
        signal: controller.signal,
        cache: 'no-store',
        mode: 'cors',
        headers: { 'X-Keep-Alive-Client': 'multi-server-monitor' }
      });
      return resp;
    } finally {
      clearTimeout(id);
    }
  }
  
  // Ping logic for a specific server
  async function performPing(serverId) {
    const server = SERVERS.find(s => s.id === serverId);
    const state = serverStates[serverId];
    
    state.attempts++;
    updateServerCard(serverId);
    
    const url = `${server.url}?t=${Date.now()}`;
    addLog(`[${server.name}] Pinging...`, 'log-info', server.color);
    
    const start = performance.now();
    try {
      const resp = await fetchWithTimeout(url);
      const elapsed = Math.round(performance.now() - start);
      const status = resp.status;
      
      let bodyText = '';
      try {
        bodyText = await resp.text();
        if (bodyText.length > 300) bodyText = bodyText.slice(0, 300) + '...';
      } catch (e) {
        bodyText = '<no body>';
      }
      
      if (resp.ok) {
        state.success++;
        totalSuccess++;
        state.lastPing = {
          success: true,
          message: `‚úÖ HTTP ${status} - ${elapsed}ms - ${bodyText}`
        };
        addLog(`[${server.name}] ‚úÖ Success: ${status} (${elapsed}ms)`, 'log-ok', server.color);
        
        // Reset backoff on success
        if (state.backoff) {
          addLog(`[${server.name}] Backoff reset`, 'log-warn', server.color);
          state.backoff = 0;
        }
      } else {
        state.fail++;
        totalFail++;
        state.lastPing = {
          success: false,
          message: `‚ùå HTTP ${status} - ${elapsed}ms`
        };
        addLog(`[${server.name}] ‚ö†Ô∏è Failed: ${status} (${elapsed}ms)`, 'log-warn', server.color);
        
        // Apply backoff for rate limiting or server errors
        if (status === 429 || status === 503 || status >= 500) {
          const ra = resp.headers.get('Retry-After');
          if (ra) {
            let raMs = parseInt(ra, 10) * 1000;
            if (isNaN(raMs)) {
              const t = Date.parse(ra);
              raMs = isNaN(t) ? null : Math.max(0, t - Date.now());
            }
            if (raMs) {
              state.backoff = Math.min(MAX_BACKOFF_MS, Math.max(state.backoff || INITIAL_BACKOFF_MS, raMs));
            } else {
              state.backoff = Math.min(MAX_BACKOFF_MS, (state.backoff || INITIAL_BACKOFF_MS) * 2);
            }
          } else {
            state.backoff = Math.min(MAX_BACKOFF_MS, (state.backoff || INITIAL_BACKOFF_MS) * 2);
          }
          addLog(`[${server.name}] üîÑ Backoff: ${Math.round(state.backoff/1000)}s`, 'log-warn', server.color);
        }
      }
    } catch (err) {
      const elapsed = Math.round(performance.now() - start);
      state.fail++;
      totalFail++;
      state.lastPing = {
        success: false,
        message: `‚ùå Error: ${err.message} (${elapsed}ms)`
      };
      addLog(`[${server.name}] ‚ùå Error: ${err.message}`, 'log-err', server.color);
      
      // Apply backoff for network errors
      state.backoff = Math.min(MAX_BACKOFF_MS, (state.backoff || INITIAL_BACKOFF_MS) * 2);
      addLog(`[${server.name}] üîÑ Backoff: ${Math.round(state.backoff/1000)}s`, 'log-warn', server.color);
    }
    
    updateServerCard(serverId);
    updateGlobalStats();
  }
  
  // Schedule next ping for a server
  function scheduleNext(serverId) {
    const server = SERVERS.find(s => s.id === serverId);
    const state = serverStates[serverId];
    
    if (!state.running) {
      state.lastStatus = 'paused';
      updateServerCard(serverId);
      return;
    }
    
    const base = state.backoff || TARGET_INTERVAL_MS;
    const jitter = Math.floor((Math.random() * (JITTER_MS * 2)) - JITTER_MS);
    const nextMs = Math.max(10000, base + jitter);
    
    state.lastStatus = 'running';
    updateServerCard(serverId);
    
    if (state.timerId) clearTimeout(state.timerId);
    state.timerId = setTimeout(async () => {
      await performPing(serverId);
      scheduleNext(serverId);
    }, nextMs);
  }
  
  // Server control functions
  function startServer(serverId) {
    const state = serverStates[serverId];
    const server = SERVERS.find(s => s.id === serverId);
    if (state.running) return;
    
    state.running = true;
    addLog(`[${server.name}] ‚ñ∂Ô∏è Started`, 'log-info', server.color);
    scheduleNext(serverId);
    updateGlobalStats();
  }
  
  function pauseServer(serverId) {
    const state = serverStates[serverId];
    const server = SERVERS.find(s => s.id === serverId);
    if (!state.running) return;
    
    state.running = false;
    if (state.timerId) {
      clearTimeout(state.timerId);
      state.timerId = null;
    }
    state.lastStatus = 'paused';
    addLog(`[${server.name}] ‚è∏Ô∏è Paused`, 'log-warn', server.color);
    updateServerCard(serverId);
    updateGlobalStats();
  }
  
  function stopServer(serverId) {
    const state = serverStates[serverId];
    const server = SERVERS.find(s => s.id === serverId);
    
    state.running = false;
    if (state.timerId) {
      clearTimeout(state.timerId);
      state.timerId = null;
    }
    state.lastStatus = 'stopped';
    addLog(`[${server.name}] ‚èπÔ∏è Stopped`, 'log-err', server.color);
    updateServerCard(serverId);
    updateGlobalStats();
  }
  
  // Global control functions
  function startAll() {
    globalRunning = true;
    SERVERS.forEach(server => startServer(server.id));
    addLog('üöÄ All servers started', 'log-ok');
  }
  
  function pauseAll() {
    SERVERS.forEach(server => pauseServer(server.id));
    addLog('‚è∏Ô∏è All servers paused', 'log-warn');
  }
  
  function stopAll() {
    globalRunning = false;
    SERVERS.forEach(server => stopServer(server.id));
    addLog('‚èπÔ∏è All servers stopped', 'log-err');
  }
  
  // Create server cards
  function createServerCards() {
    serversGrid.innerHTML = SERVERS.map(server => `
      <div class="server-card" id="server-${server.id}">
        <div class="server-header">
          <div class="server-name">
            <span>üñ•Ô∏è</span>
            <span>${server.name}</span>
          </div>
          <div class="server-status-badge badge-stopped">stopped</div>
        </div>
        <div class="server-body">
          <div class="server-url">${server.url}</div>
          <div class="server-stats">
            <div class="stat-item">
              <div class="stat-label">Attempts</div>
              <div class="stat-value stat-attempts">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Success</div>
              <div class="stat-value stat-success stat-success">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Failed</div>
              <div class="stat-value stat-fail stat-fail">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Backoff</div>
              <div class="stat-value stat-backoff">none</div>
            </div>
          </div>
          <div class="server-controls">
            <button class="btn-start" onclick="window.serverControl.start(${server.id})">‚ñ∂Ô∏è Start</button>
            <button class="btn-pause" onclick="window.serverControl.pause(${server.id})">‚è∏Ô∏è Pause</button>
            <button class="btn-stop" onclick="window.serverControl.stop(${server.id})">‚èπÔ∏è Stop</button>
          </div>
          <div class="server-last-ping">No ping yet</div>
        </div>
      </div>
    `).join('');
  }
  
  // Expose server controls globally
  window.serverControl = {
    start: startServer,
    pause: pauseServer,
    stop: stopServer
  };
  
  // Global button handlers
  document.getElementById('btnStartAll').addEventListener('click', startAll);
  document.getElementById('btnPauseAll').addEventListener('click', pauseAll);
  document.getElementById('btnStopAll').addEventListener('click', stopAll);
  document.getElementById('btnClearLog').addEventListener('click', () => {
    logLines = [];
    renderLog();
    addLog('üóëÔ∏è Log cleared', 'log-info');
  });
  document.getElementById('btnDownloadLog').addEventListener('click', () => {
    const text = logLines.map(l => l.text).join('\n');
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `server-monitor-${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  });
  
  // Initialize
  createServerCards();
  addLog('üéØ Multi-Server Monitor initialized', 'log-info');
  addLog('üí° Click "Start All" to begin monitoring all servers', 'log-info');
  updateGlobalStats();
})();
</script>
</body>
</html>

